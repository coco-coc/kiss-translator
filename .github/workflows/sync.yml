# .github/workflows/sync_upstream.yml

name: Sync Upstream Repository

on:
  # 定时触发：每6小时执行一次
  schedule:
    - cron: '0 */6 * * *'
  
  # 手动触发
  workflow_dispatch:

# 环境变量，请根据你的情况修改
env:
  # 源仓库（你要同步的仓库）
  UPSTREAM_REPO: "https://github.com/fishjar/kiss-translator.git" 
  # 你的目标仓库（当前仓库）
  DESTINATION_REPO: "https://github.com/coco-coc/kiss-translator.git"
  # 源仓库的 用户名/仓库名 格式
  UPSTREAM_REPO_NAME: "fishjar/kiss-translator"

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # ----------------------------------------------------
      # 步骤 1: 镜像同步所有 Git 分支和标签
      # ----------------------------------------------------
      - name: Mirror Git Repository
        run: |
          echo "Cloning upstream repository as a mirror..."
          git clone --mirror ${{ env.UPSTREAM_REPO }} upstream_mirror
          
          cd upstream_mirror
          
          echo "Setting push URL to destination repository..."
          # 使用你配置的 PAT 进行认证
          git remote set-url --push origin "https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git"
          
          echo "Pushing all branches..."
          # 推送所有分支。'refs/heads/*:refs/heads/*' 是一个 refspec，表示将本地的所有分支推送到远程的同名分支
          git push --force origin 'refs/heads/*:refs/heads/*'
          
          echo "Pushing all tags..."
          # 推送所有标签
          git push --force origin 'refs/tags/*:refs/tags/*'

      # ----------------------------------------------------
      # 步骤 2: 同步所有 Releases (只增不删)
      # ----------------------------------------------------
      - name: Sync Releases
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching releases from upstream repository: ${{ env.UPSTREAM_REPO_NAME }}"
          RELEASES=$(gh release list -R ${{ env.UPSTREAM_REPO_NAME }} --json tagName,name,body,isPrerelease,publishedAt,assets)
          TAGS_TO_SYNC=$(echo "$RELEASES" | jq -r '.[].tagName' | tac)
          
          if [ -z "$TAGS_TO_SYNC" ]; then
            echo "No releases found in the upstream repository. Skipping release sync."
            exit 0
          fi
          
          echo "Found releases for tags: $TAGS_TO_SYNC"

          for tag in $TAGS_TO_SYNC; do
            echo "Processing release for tag: $tag"
            
            if gh release view "$tag" -R ${{ github.repository }} >/dev/null 2>&1; then
              echo "Release for tag $tag already exists in the destination repository. Skipping."
              continue
            fi
            
            echo "Release for $tag does not exist. Creating..."
            
            RELEASE_INFO=$(echo "$RELEASES" | jq --arg tag "$tag" '.[] | select(.tagName == $tag)')
            RELEASE_NAME=$(echo "$RELEASE_INFO" | jq -r '.name')
            RELEASE_BODY=$(echo "$RELEASE_INFO" | jq -r '.body')
            IS_PRERELEASE=$(echo "$RELEASE_INFO" | jq -r '.isPrerelease')
            
            GH_COMMAND="gh release create '$tag' --title '$RELEASE_NAME' --notes '$RELEASE_BODY'"
            [ "$IS_PRERELEASE" = "true" ] && GH_COMMAND="$GH_COMMAND --prerelease"
            
            ASSETS=$(echo "$RELEASE_INFO" | jq -r '.assets[] | .name')
            if [ -n "$ASSETS" ]; then
              mkdir -p assets_temp
              gh release download "$tag" -R ${{ env.UPSTREAM_REPO_NAME }} -D ./assets_temp -p "*"
              for asset in assets_temp/*; do GH_COMMAND="$GH_COMMAND '$asset'"; done
            fi

            eval "$GH_COMMAND"
            rm -rf assets_temp
            echo "Successfully created release for tag $tag in ${{ github.repository }}"
            echo "---------------------------------"
            sleep 2
          done
          
          echo "All releases have been synced."
